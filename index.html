<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Acloin</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* NEON OBSIDIAN THEME */
        :root {
            --bg-color: #050505;
            --card-bg: #121212;
            --primary: #8b5cf6; /* Violet */
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
        }
        body { background-color: var(--bg-color); color: white; font-family: 'Segoe UI', Roboto, sans-serif; overflow: hidden; }

        .tinder-card {
            position: absolute; width: 100%; height: 100%;
            background-color: var(--card-bg);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            transition: transform 0.4s ease-out, opacity 0.4s;
            border: 1px solid #333;
        }

        .nav-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: 70px;
            background: rgba(0,0,0,0.9);
            border-top: 1px solid #222;
            display: flex; justify-content: space-around; align-items: center;
            z-index: 50;
        }
        .nav-btn.active { color: var(--primary); transform: scale(1.1); }

        .page { display: none; padding: 20px; height: 100vh; overflow-y: auto; padding-bottom: 100px; }
        .page.active { display: block; animation: fade 0.3s; }
        @keyframes fade { from { opacity: 0; } to { opacity: 1; } }

        /* Setup Modal */
        #setup-modal { backdrop-filter: blur(20px); }
    </style>
</head>
<body>

    <div id="loader" class="fixed inset-0 bg-[#050505] z-50 flex justify-center items-center">
        <div class="text-violet-500 font-bold text-2xl animate-pulse">Acloin System</div>
    </div>

    <div id="setup-modal" class="fixed inset-0 bg-black/90 z-40 flex flex-col justify-center items-center p-6 hidden">
        <div class="bg-[#1a1a1a] p-6 rounded-2xl w-full border border-gray-800">
            <h2 class="text-xl font-bold mb-2">üì° –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</h2>
            <p class="text-sm text-gray-400 mb-4">–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –∏–∑ Ngrok, —á—Ç–æ–±—ã —Å–∞–π—Ç —É–≤–∏–¥–µ–ª –±–æ—Ç–∞.</p>
            <input type="text" id="api-input" placeholder="https://xxxx.ngrok-free.app" class="w-full p-3 bg-black rounded-lg mb-4 text-white border border-gray-700 focus:border-violet-500 outline-none">
            <button onclick="saveApi()" class="w-full p-3 bg-violet-600 rounded-lg font-bold shadow-lg shadow-violet-900/50">–ü–û–î–ö–õ–Æ–ß–ò–¢–¨</button>
        </div>
    </div>

    <div id="tab-search" class="page active" style="overflow: hidden;">
        <div class="flex justify-between items-center mb-4">
            <span class="text-xl font-bold">Acloin</span>
            <div class="px-2 py-1 rounded bg-violet-500/20 text-violet-300 text-xs font-bold border border-violet-500/30">APP V14</div>
        </div>

        <div class="relative w-full h-[65vh] perspective-1000" id="card-stack">
            <div class="flex flex-col items-center justify-center h-full text-gray-500">
                <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∫–µ—Ç...</p>
            </div>
        </div>

        <div class="flex justify-center items-center gap-6 mt-6">
            <button onclick="vote('dislike')" class="w-14 h-14 rounded-full bg-[#1a1a1a] text-red-500 text-2xl border border-red-900/30 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            <button onclick="vote('like')" class="w-14 h-14 rounded-full bg-[#1a1a1a] text-green-500 text-2xl border border-green-900/30 flex items-center justify-center"><i class="fa-solid fa-heart"></i></button>
        </div>
    </div>

    <div id="tab-profile" class="page">
        <div class="flex flex-col items-center pt-6">
            <img id="my-avatar" src="" class="w-28 h-28 rounded-full object-cover border-4 border-[#050505] mb-3 bg-gray-800">
            <h1 id="my-name" class="text-2xl font-bold">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
            <p id="my-info" class="text-gray-500 text-sm">...</p>

            <div class="w-full mt-8 space-y-3">
                <div class="p-4 bg-[#111] rounded-xl border border-gray-800 flex justify-between items-center" onclick="tg.close()">
                    <span>‚¨ÖÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –±–æ—Ç–∞</span>
                </div>
                <div class="p-4 bg-[#111] rounded-xl border border-gray-800 flex justify-between items-center text-red-400" onclick="resetApi()">
                    <span>üîå –°–±—Ä–æ—Å–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</span>
                </div>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <button onclick="switchTab('profile')" id="btn-profile" class="text-gray-500 flex flex-col items-center p-2"><i class="fa-regular fa-user text-xl"></i></button>
        <button onclick="switchTab('search')" id="btn-search" class="text-violet-500 flex flex-col items-center p-2"><div class="w-12 h-12 bg-violet-600 rounded-full flex items-center justify-center -mt-6 border-4 border-[#050505] shadow-lg shadow-violet-900/50"><i class="fa-solid fa-fire text-white"></i></div></button>
        <button id="btn-chat" class="text-gray-500 flex flex-col items-center p-2 opacity-50"><i class="fa-regular fa-comment text-xl"></i></button>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand();
        const user = tg.initDataUnsafe.user;
        let API = localStorage.getItem('acloin_api');
        let profiles = [];
        let currentIdx = 0;

        function init() {
            if(!API) {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('setup-modal').classList.remove('hidden');
            } else {
                document.getElementById('loader').style.display = 'none';
                loadMe();
                loadFeed();
            }
        }

        function saveApi() {
            let val = document.getElementById('api-input').value.trim();
            if(val) {
                if(val.endsWith('/')) val = val.slice(0, -1);
                localStorage.setItem('acloin_api', val);
                API = val;
                document.getElementById('setup-modal').classList.add('hidden');
                init();
            }
        }

        function resetApi() {
            localStorage.removeItem('acloin_api');
            location.reload();
        }

        async function loadMe() {
            if(!user) return;
            try {
                const res = await fetch(`${API}/api/me`, {
                    method: 'POST', 
                    body: JSON.stringify({tg_id: user.id})
                });
                const data = await res.json();
                if(data.user) {
                    document.getElementById('my-name').innerText = data.user.name + ", " + data.user.age;
                    document.getElementById('my-info').innerText = data.user.city;
                    if(data.user.avatar_url) document.getElementById('my-avatar').src = data.user.avatar_url;
                }
            } catch(e) { console.log(e); }
        }

        async function loadFeed() {
            if(!user) return;
            try {
                const res = await fetch(`${API}/api/feed`, {
                    method: 'POST',
                    body: JSON.stringify({tg_id: user.id})
                });
                const data = await res.json();
                if(data.profiles) {
                    profiles = data.profiles;
                    currentIdx = 0;
                    renderCard();
                }
            } catch(e) {
                document.getElementById('card-stack').innerHTML = `<div class='text-center text-red-500 mt-20'>–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏.<br>–ü—Ä–æ–≤–µ—Ä—å Ngrok.</div>`;
            }
        }

        function renderCard() {
            const stack = document.getElementById('card-stack');
            stack.innerHTML = '';

            if(currentIdx >= profiles.length) {
                stack.innerHTML = `<div class='flex flex-col items-center justify-center h-full text-gray-500'><p>–ê–Ω–∫–µ—Ç—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å :(</p><button class='mt-4 px-4 py-2 bg-[#222] rounded' onclick='loadFeed()'>–û–±–Ω–æ–≤–∏—Ç—å</button></div>`;
                return;
            }

            const p = profiles[currentIdx];
            const img = p.avatar_url || 'https://via.placeholder.com/400x600?text=No+Photo';

            stack.innerHTML = `
                <div class="tinder-card" style="background-image: url('${img}'); background-size: cover;">
                    <div class="absolute bottom-0 w-full p-6 bg-gradient-to-t from-black via-black/80 to-transparent">
                        <h2 class="text-3xl font-bold text-white mb-1">${p.name}, ${p.age}</h2>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="bg-violet-600 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider">${p.style}</span>
                            <span class="text-gray-300 text-sm"><i class="fa-solid fa-location-dot"></i> ${p.city}</span>
                        </div>
                        ${p.description ? `<p class="text-gray-400 text-xs line-clamp-2">${p.description}</p>` : ''}
                    </div>
                </div>`;
        }

        async function vote(action) {
            const card = document.querySelector('.tinder-card');
            if(!card) return;
            const p = profiles[currentIdx];

            // Animation
            const x = action === 'like' ? 200 : -200;
            const rot = action === 'like' ? 15 : -15;
            card.style.transform = `translateX(${x}%) rotate(${rot}deg)`;
            card.style.opacity = '0';

            // API
            try {
                await fetch(`${API}/api/action`, {
                    method: 'POST',
                    body: JSON.stringify({from_id: user.id, to_id: p.tg_id, action: action})
                });
            } catch(e) {}

            setTimeout(() => {
                currentIdx++;
                renderCard();
            }, 300);
        }

        function switchTab(id) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');

            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            if(id !== 'search') document.getElementById('btn-' + id).classList.add('active');
        }

        init();
    </script>
</body>
</html>
