<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Acloin</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --bg: #050505; --card: #121212; --primary: #8b5cf6; --glass: rgba(255,255,255,0.05); }
        body { background: var(--bg); color: white; font-family: sans-serif; overflow: hidden; }
        .glass { background: var(--glass); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; }
        .tinder-card { position: absolute; width: 100%; height: 100%; background: var(--card); border-radius: 24px; overflow: hidden; transition: 0.4s; }
        .card-container { position: relative; width: 100%; height: 60vh; perspective: 1000px; margin-top: 10px; }
        .page { display: none; padding: 20px; height: 100vh; }
        .page.active { display: block; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; height: 70px; background: rgba(0,0,0,0.9); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #333; }
    </style>
</head>
<body>
    <div id="loader" class="fixed inset-0 bg-[#050505] z-50 flex justify-center items-center"><div class="text-violet-500 font-bold text-2xl animate-pulse">Connecting...</div></div>

    <div id="setup-modal" class="fixed inset-0 bg-[#050505] z-50 flex flex-col justify-center items-center p-6 hidden">
        <h2 class="text-xl font-bold mb-4">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</h2>
        <p class="text-sm text-gray-400 mb-4 text-center">–í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –∏–∑ Ngrok (Forwarding URL), —á—Ç–æ–±—ã —Å–∞–π—Ç —É–≤–∏–¥–µ–ª –±–æ—Ç–∞.</p>
        <input type="text" id="api-url-input" placeholder="https://xxxx-xx.ngrok-free.app" class="w-full p-3 bg-[#1a1a1a] rounded-lg mb-4 text-white">
        <button onclick="saveApiUrl()" class="w-full p-3 bg-violet-600 rounded-lg font-bold">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
    </div>

    <div id="tab-search" class="page active">
        <div class="flex justify-between items-center mb-4"><span class="font-bold text-xl">Acloin</span><span class="text-violet-400 font-bold text-xs border border-violet-800 px-2 py-1 rounded">BETA</span></div>
        <div class="card-container" id="card-stack">
            <div class="flex flex-col items-center justify-center h-full text-gray-500"><i class="fa-solid fa-spinner fa-spin mb-2"></i><p>–ü–æ–∏—Å–∫...</p></div>
        </div>
        <div class="flex justify-center gap-6 mt-6">
            <button onclick="vote('dislike')" class="w-14 h-14 rounded-full bg-[#1a1a1a] text-red-500 text-2xl border border-red-900/30"><i class="fa-solid fa-xmark"></i></button>
            <button onclick="vote('like')" class="w-14 h-14 rounded-full bg-[#1a1a1a] text-green-500 text-2xl border border-green-900/30"><i class="fa-solid fa-heart"></i></button>
        </div>
    </div>

    <div id="tab-profile" class="page">
        <div class="flex flex-col items-center pt-4">
            <img id="my-avatar" src="" class="w-24 h-24 rounded-full border-4 border-[#050505] mb-2 object-cover">
            <h1 id="my-name" class="text-2xl font-bold">...</h1>
            <div class="glass w-full p-4 mt-6 flex justify-between items-center" onclick="tg.close()">
                <span>‚¨ÖÔ∏è –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ —á–∞—Ç</span>
            </div>
            <div class="glass w-full p-4 mt-2 flex justify-between items-center" onclick="resetApi()">
                <span class="text-red-400">üîå –°–±—Ä–æ—Å–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</span>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <button onclick="switchTab('profile')" class="text-gray-500"><i class="fa-regular fa-user text-xl"></i></button>
        <button onclick="switchTab('search')" class="text-violet-500"><div class="w-12 h-12 bg-violet-600 rounded-full flex items-center justify-center -mt-6 border-4 border-[#050505]"><i class="fa-solid fa-fire text-white"></i></div></button>
        <button class="text-gray-500"><i class="fa-regular fa-comment text-xl"></i></button>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand();
        const user = tg.initDataUnsafe.user;
        let API_URL = localStorage.getItem('api_url');
        let profiles = [];
        let currentIdx = 0;

        function init() {
            if(!API_URL) {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('setup-modal').classList.remove('hidden');
            } else {
                document.getElementById('loader').classList.add('hidden');
                loadMe();
                loadFeed();
            }
        }

        function saveApiUrl() {
            const url = document.getElementById('api-url-input').value.trim();
            if(url) {
                localStorage.setItem('api_url', url.replace(/\/$/, "")); // —É–±–∏—Ä–∞–µ–º —Å–ª–µ—à –≤ –∫–æ–Ω—Ü–µ
                API_URL = url;
                document.getElementById('setup-modal').classList.add('hidden');
                loadMe();
                loadFeed();
            }
        }

        function resetApi() {
            localStorage.removeItem('api_url');
            location.reload();
        }

        async function loadMe() {
            if(!user) return;
            try {
                const res = await fetch(`${API_URL}/api/me`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({tg_id: user.id})
                });
                const data = await res.json();
                if(data.user) {
                    document.getElementById('my-name').innerText = data.user.name + ", " + data.user.age;
                    if(user.photo_url) document.getElementById('my-avatar').src = user.photo_url;
                }
            } catch(e) { console.error(e); }
        }

        async function loadFeed() {
            if(!user) return;
            try {
                const res = await fetch(`${API_URL}/api/feed`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({tg_id: user.id})
                });
                const data = await res.json();
                if(data.profiles) {
                    profiles = data.profiles;
                    currentIdx = 0;
                    renderCard();
                }
            } catch(e) {
                document.getElementById('card-stack').innerHTML = `<div class='text-center text-red-500'>–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–æ—Ç–æ–º.<br>–ü—Ä–æ–≤–µ—Ä—å Ngrok.</div>`;
            }
        }

        function renderCard() {
            const stack = document.getElementById('card-stack');
            stack.innerHTML = '';
            if(currentIdx >= profiles.length) {
                stack.innerHTML = `<div class='text-center text-gray-500 mt-20'>–ê–Ω–∫–µ—Ç—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å</div>`;
                return;
            }
            const p = profiles[currentIdx];
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä, –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ
            const img = p.avatar_url || 'https://via.placeholder.com/400x600?text=No+Photo';

            stack.innerHTML = `
                <div class="tinder-card" style="background-image: url('${img}'); background-size: cover;">
                    <div class="absolute bottom-0 w-full p-5 bg-gradient-to-t from-black to-transparent">
                        <h2 class="text-3xl font-bold">${p.name}, ${p.age}</h2>
                        <span class="bg-violet-600 px-2 py-1 rounded text-xs font-bold uppercase">${p.style}</span>
                        <p class="text-gray-300 text-sm mt-1">üìç ${p.city}</p>
                        ${p.description ? `<p class="text-gray-400 text-xs mt-1 line-clamp-2">${p.description}</p>` : ''}
                    </div>
                </div>`;
        }

        async function vote(action) {
            const card = document.querySelector('.tinder-card');
            if(!card) return;
            const p = profiles[currentIdx];

            // UI Animation
            const x = action === 'like' ? 200 : -200;
            card.style.transform = `translateX(${x}%) rotate(${x/10}deg)`;
            card.style.opacity = 0;

            // API Call
            try {
                await fetch(`${API_URL}/api/action`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({from_id: user.id, to_id: p.tg_id, action: action})
                });
            } catch(e) { console.error(e); }

            setTimeout(() => {
                currentIdx++;
                renderCard();
            }, 300);
        }

        function switchTab(id) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
        }

        init();
    </script>
</body>
</html>
